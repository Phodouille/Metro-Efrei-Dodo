<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MetroGo - Travel Planner</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="style.css" rel="stylesheet">
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div id="app" class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <h2 class="text-center">MetroGo</h2>
        <a href="#">Travel</a>
        <a href="#">Graph</a>
        <a href="#">Recents</a>
        <a href="#">Saved</a>
      </div>

      <!-- Main content -->
      <div class="col-md-10 p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1>Time to ride !</h1>
            <h4>Where to this time ?</h4>
          </div>
          <div><strong>2:30 PM, Paris</strong></div>
        </div>

        <!-- Station selection -->
        <div class="mb-4">
          <div class="mb-2">
            <label>From</label>
            <select class="form-select" v-model="from">
              <option disabled value="">Select station</option>
              <option v-for="station in stations" :value="station">{{ station }}</option>
            </select>
          </div>
          <div class="mb-2">
            <label>To</label>
            <select class="form-select" v-model="to">
              <option disabled value="">Select station</option>
              <option v-for="station in stations" :value="station">{{ station }}</option>
            </select>
          </div>
          <button class="btn btn-dark mt-2" @click="searchRoutes">Search</button>
        </div>

        <!-- Routes + Map -->
        <div class="row">
          <div class="col-md-6">
            <div v-for="(route, index) in routes" :key="index" class="route-option" :class="{ selected: index === selectedRoute }" @click="selectRoute(index)">
              <div>
                <span v-for="line in route.lines" :key="line" class="metro-icon" :class="'line-' + line">{{ line }}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <span>€2.50</span>
                <strong>{{ route.duration }} min</strong>
              </div>
              <div class="mt-1 small">{{ route.path.join(" → ") }}</div>
            </div>
          </div>

          <div class="col-md-6">
            <div id="map" style="height: 400px; border-radius: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue app -->
  <script>
  const app = Vue.createApp({
    data() {
      return {
        stations: [],
        from: '',
        to: '',
        routes: [],
        selectedRoute: 0,
        map: null,
        polyline: null,
      };
    },
    mounted() {
      this.fetchStations();
      this.initMap();
    },
    methods: {
      fetchStations() {
        fetch("http://127.0.0.1:5000/api/stations")
          .then(res => res.json())
          .then(data => {
            this.stations = data;
          });
      },
      searchRoutes() {
        if (!this.from || !this.to) return;

        fetch("http://127.0.0.1:5000/api/shortest_path", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ from: this.from, to: this.to }),
        })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert("Erreur : " + data.error);
            return;
          }
          this.routes = data;
          this.selectedRoute = 0;
          this.showRouteOnMap(data[0].coordinates);
        });
      },
      selectRoute(index) {
        this.selectedRoute = index;
        const coords = this.routes[index].coordinates;
        this.showRouteOnMap(coords);
      },
      initMap() {
        this.map = L.map("map").setView([48.8566, 2.3522], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(this.map);
      },
      showRouteOnMap(coords) {
        if (this.polyline) {
          this.map.removeLayer(this.polyline);
        }
        this.polyline = L.polyline(coords, { color: "blue" }).addTo(this.map);
        this.map.fitBounds(this.polyline.getBounds());
      }
    }
  });

  app.mount("#app");
</script>
</body>
</html>
